name: CI

on:
  pull_request:
  push:
  merge_group:

env:
  GH_TOKEN: ${{ github.token }}
  RUSTFLAGS: -Dwarnings
  RUSTDOCFLAGS: -Dwarnings

defaults:
  run:
    shell: bash

jobs:
  run-hermit:
    name: Run
    runs-on: ubuntu-24.04
    defaults:
      run:
        working-directory: kernel
    steps:
      - name: Checkout hermit-rs
        uses: actions/checkout@v4
        with:
          repository: hermit-os/hermit-rs
          submodules: true
      - name: Remove hermit-kernel submodule
        run: git rm -r kernel
        working-directory: .
      - name: Checkout hermit-kernel
        uses: actions/checkout@v4
        with:
          path: kernel
      - name: Install QEMU
        run: |
          sudo apt-get update
          sudo apt-get install --no-install-recommends qemu-system-x86
      - uses: dtolnay/rust-toolchain@stable
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src
      - uses: mkroening/rust-toolchain-toml@main
      - uses: mkroening/rust-toolchain-toml@main
        with:
          toolchain-file: "kernel/rust-toolchain.toml"
      - name: Download loader
        run: gh release download --repo hermit-os/loader --pattern hermit-loader-x86_64
      - run: |
          cd ..
          cargo build --target=x86_64-unknown-hermit -Zbuild-std=std,panic_abort --package httpd --features ci,hermit/log-target,hermit/trace
          cd kernel
        env:
          HERMIT_LOG_LEVEL_FILTER: trace
      - run: |
          sudo qemu-system-x86_64 \
            -display none -serial stdio \
            -kernel hermit-loader-x86_64 \
            -initrd ../target/x86_64-unknown-hermit/debug/httpd \
            -enable-kvm -cpu host \
            -device isa-debug-exit,iobase=0xf4,iosize=0x04 \
            -smp 1 -m 1024M \
            -netdev tap,id=net0,ifname=tap10,script=xtask/hermit-ifup,vhost=on \
            -device virtio-net-pci,netdev=net0,disable-legacy=on &
          sleep 10
          curl -4 -v 10.0.5.3:9975
      - run: |
          pushd ../benches/netbench
          cargo build --target=x86_64-unknown-hermit -Zbuild-std=std,panic_abort --bin tcp-server-bw --release
          popd
      - run: |
          sudo qemu-system-x86_64 \
            -display none -serial stdio \
            -kernel hermit-loader-x86_64 \
            -initrd ../target/x86_64-unknown-hermit/release/tcp-server-bw \
            -enable-kvm -cpu host \
            -device isa-debug-exit,iobase=0xf4,iosize=0x04 \
            -smp 1 -m 1024M \
            -netdev tap,id=net0,ifname=tap10,script=xtask/hermit-ifup,vhost=on \
            -device virtio-net-pci,netdev=net0,disable-legacy=on \
            -append "-- --address 10.0.5.1 --bytes 1048576 --rounds 10" &
          sleep 10
          pushd ../benches/netbench
          cargo run --bin tcp-client-bw --release -- --address 10.0.5.3 --bytes 1048576 --rounds 10
          popd
      - run: |
          pushd ../benches/netbench
          cargo build --target=x86_64-unknown-hermit -Zbuild-std=std,panic_abort --bin tcp-client-bw --release
          popd
      - run: |
          pushd ../benches/netbench
          cargo run --bin tcp-client-bw --release -- --address 10.0.5.3 --bytes 1048576 --rounds 10
          popd
          sleep 30
          sudo qemu-system-x86_64 \
            -display none -serial stdio \
            -kernel hermit-loader-x86_64 \
            -initrd ../target/x86_64-unknown-hermit/release/tcp-client-bw \
            -enable-kvm -cpu host \
            -device isa-debug-exit,iobase=0xf4,iosize=0x04 \
            -smp 1 -m 1024M \
            -netdev tap,id=net0,ifname=tap10,script=xtask/hermit-ifup,vhost=on \
            -device virtio-net-pci,netdev=net0,disable-legacy=on \
            -append "-- --address 10.0.5.1 --bytes 1048576 --rounds 10" &
